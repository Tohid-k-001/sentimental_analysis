name: Azure Streamlit Sentiment Analysis Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Step 1 â€” Checkout code from GitHub
      - name: Checkout repository
        uses: actions/checkout@v3

      # ğŸ Step 2 â€” Set up Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ğŸ“¦ Step 3 â€” Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # âœ… Step 4 â€” Verify Streamlit is installed
      - name: Verify Streamlit installation
        run: |
          streamlit --version

      # ğŸ§  Step 5 â€” Deploy to Azure Web App
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: sentimentanalysis        # ğŸ”¹ Must exactly match your Azure Web App name
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}  # ğŸ”¹ From Azure â†’ "Get Publish Profile"
          package: ./

      # ğŸ” Step 6 â€” Optional restart (ensures new container starts cleanly)
      - name: Restart Azure Web App
        run: |
          echo "Restarting Azure Web App..."
          curl -X POST "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Web/sites/sentimentanalysis/restart?api-version=2021-03-01" \
          -H "Authorization: Bearer ${{ secrets.AZURE_ACCESS_TOKEN }}" || true
